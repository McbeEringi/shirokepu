<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>しろけぷ発言まとめ - ホーム</title>
	<link rel="stylesheet" href="https://mcbeeringi.github.io/src/style.css">
	<link rel="stylesheet" href="style.css">
</head>
<body>
	<div class="title">
		<h1>しろけぷ発言まとめ</h1>
		<p id="breaf">読み込み中…</p>
	</div>
	<hr>
	<div class="stuff" id="wrap">
		<div><h3>すべて</h3><hr><ul><li><a href="viewer.html">すべて</a></li><li><a href id="rand">おまかせ</a></li></ul></div>
	</div>
	<script src="com.js"></script>
	<script>
		fetch('main.json').then(x=>x.json()).then(x=>{
			x.data=x.data.map(y=>[y,Math.floor(y.date*.01)]);
			x.month=[...new Set(x.data.map(y=>y[1]))];
			x.tmp=Object.fromEntries(x.month.map((y,i)=>[y,i]));
			x.data=x.data.map(y=>({...y[0],month:x.tmp[y[1]]}));
			x.month=x.month.map(y=>`20${Math.floor(y*.01)}年${y%100}月`);
			x.tmp=x.data.reduce((a,y)=>{
				a.month[y.month].push(y.no);
				a.member[y.member].push(y.no);
				y.tag.forEach(z=>a.tag[z].push(y.no));
				return a;
			},Object.fromEntries(['month','member','tag'].map(y=>[y,new Array(x[y].length).fill().map(()=>[])])));
			wrap.insertAdjacentHTML('beforeend',
					[['月別','month',''],['発言者別','member','発言者:'],['タグ別','tag','タグ:']]
						.map(y=>[y[0],x[y[1]].map((z,i)=>`<li><a href="viewer.html?${urlq_({i:x.tmp[y[1]][i],subt:[y[2]+(z.name||z)]})}">${z.name||z} (${x.tmp[y[1]][i].length}件)</a></li>`)])
						.map(y=>`<div><h3>${y[0]}</h3><hr><ul>${y[1].join('')}</ul></div>`).join('')
			);

			const draw=()=>Promise.all([['month','月別 発言数合計'],['member','発言数合計'],['tag','タグ別 発言数合計']].map((y,i)=>new Promise(f=>{
				const sty=getComputedStyle(document.body),
					h=64,
					arr=x[y[0]].map((z,i)=>[z.name||z,x.tmp[y[0]][i].length]),
					c=Object.assign(document.createElement('canvas'),{width:1024,height:h*(arr.length+1)}),
					ctx=Object.assign(c.getContext('2d'),{textAlign:'left',font:'32px sans-serif',fillStyle:sty.getPropertyValue('--bc')}),
					w=(c.width-h)/Math.max(...arr.map(z=>z[1]));
				ctx.fillRect(0,0,c.width,c.height);
				arr.forEach((z,j)=>{
					j++;
					ctx.fillStyle=sty.getPropertyValue('--graph');ctx.fillRect(0,h*(j+.1),z[1]*w,h*.8);
					j=h*(j+.8);
					ctx.fillStyle=sty.getPropertyValue('--fc');ctx.fillText(z[0],0,j,h*2);ctx.fillText(z[1]+'件',h*3,j);
				});
				Object.assign(ctx,{textAlign:'center',font:'48px sans-serif'});ctx.fillText(y[1],c.width*.5,h*.8);
				c.toBlob(b=>{
					const img=document.createElement('img');
					img.onload=()=>URL.revokeObjectURL(img.src);img.style.cssText='max-width:480px;width:100%;border-radius:4px;';
					img.src=URL.createObjectURL(b);f(img);
				});
			}))).then(y=>{
				if(window.graphs)graphs.remove();
				const e=document.createElement('div');e.id='graphs';
				e.insertAdjacentHTML('beforeend','<h3>グラフ一覧</h3><hr>')
				y.forEach(z=>e.appendChild(z));
				wrap.appendChild(e);
			});
			draw();window.matchMedia('(prefers-color-scheme:light)').addEventListener('change',draw);

			breaf.textContent='';
			breaf.insertAdjacentHTML('beforeend',table([['最終追加日:',n2d(x.data[x.data.length-1].date).join('/')],['発言総数:',x.data.length]]));
			rand.onclick=e=>{e.preventDefault();Object.assign(document.createElement('a'),{href:`viewer.html?m=1&i=${x.data[Math.floor(Math.random()*x.data.length)].no}`}).click();};
		}).catch(llog);
	</script>
</body>
</html>
